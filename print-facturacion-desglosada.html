<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRINT - Facturaci√≥n Publicidad</title>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
:root{
  --card:#111827;
  --text:#e5e7eb;
  --base:#38bdf8;
  --comp:#f59e0b;
  --neg:#f87171;
  --diffColor:#6ee7b7;
  --totalBg:#1e40af;
  --revistaBg:#fef3c7; 
  --productoBg:#dbeafe; 
  --sectorBg:#fbcfe8;
  --comercialBg:#d1fae5; 
  --areaBg:#fcd5ce; 
}

body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:linear-gradient(180deg,#020617,#0f172a);
  color:var(--text);
}

/* MEN√ö DE NAVEGACI√ìN */
.nav-menu {
  background: #111827;
  padding: 15px;
  text-align: center;
  border-bottom: 1px solid #374151;
  position: sticky;
  top: 0;
  z-index: 1000;
}
.nav-menu a {
  color: white;
  margin: 0 10px;
  text-decoration: none;
  font-size: 0.9em;
  opacity: 0.8;
}
.nav-menu a:hover { opacity: 1; color: var(--comp); }
.nav-menu .active { font-weight: bold; border-bottom: 2px solid var(--comp); opacity: 1; }

h1{ text-align:center; margin:20px 0; font-size: 1.5em; }
.container{ max-width:1500px; margin:auto; padding:10px; }

.card{
  background:rgba(17,24,39,.9);
  border-radius:14px;
  padding:18px;
  margin-bottom:20px;
}

.filters select,input[type=file]{
  background:#1f2933;
  color:var(--text);
  border:1px solid #1f2937;
  padding:8px 10px;
  border-radius:8px;
  margin-bottom: 10px;
}

.filtersRow{ display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
.filtersRow div select{ width:100%; max-width: 250px; font-weight:600; }

#fSite{ background:var(--revistaBg); color:#111; }
#fProduct{ background:var(--productoBg); color:#111; }
#fSector{ background:var(--sectorBg); color:#111; }
#fComercial{ background:var(--comercialBg); color:#111; }
#fArea{ background:var(--areaBg); color:#111; }

.checkboxGroup{ display:flex; flex-wrap:wrap; gap:8px; margin-top:5px; }
.checkboxGroup label{ font-size: 0.8em; font-weight:400; background: #374151; padding: 4px 8px; border-radius: 5px; }

.totalBlock{ background:var(--totalBg); padding:15px; border-radius:12px; margin-top:10px; }
.totalValues{ display:flex; justify-content:space-around; font-size:16px; flex-wrap: wrap; gap: 10px; }
.totalValues .value{ font-size:20px; font-weight:700; display: block; }

.statsBlock{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin: 10px 0; }
.subBlock{ border-radius:12px; padding:15px; flex: 1; min-width: 280px; }
.statsBase{ background:var(--comp); color: #000; }
.statsDiff{ background:var(--diffColor); color: #000; text-align: center; font-weight: bold; }
.statsComp{ background:var(--base); color: #000; }

.statsValues{ display:flex; justify-content:space-around; gap:10px; }
.statsValues .value{ font-size:1.1em; font-weight:700; display: block; }

.grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(100%,1fr)); gap:20px; }
@media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }

.chart{ height:400px; width: 100%; }
</style>
</head>

<body>

<nav class="nav-menu">
    <span style="color: #38bdf8; font-weight: bold; margin-right: 10px; opacity: 0.6;">DIGITAL:</span>
    <a href="digital-datos-graficos.html">Datos</a>
    <a href="digital-facturacion-desglosada.html">Desglose</a>
    <a href="digital-display.html">Display</a>
    <a href="digital-totales-familas-productos.html">Productos</a>
    
    <span style="color: #f59e0b; font-weight: bold; margin-left: 20px; margin-right: 10px; border-left: 1px solid #4b5563; padding-left: 20px;">PRINT:</span>
    <a href="print-datos-graficos.html">Datos</a>
    <a href="print-facturacion-desglosada.html">Desglose</a>
    
    <a href="index.html" style="margin-left: 20px; border-left: 1px solid #4b5563; padding-left: 20px; color: #fff; opacity: 0.5;">üè† Inicio</a>
</nav>

<h1>PRINT - Estad√≠sticas y Facturaci√≥n</h1>

<div class="container">
  <div class="card">
    <label>Cargar Print.json manualmente: </label>
    <input type="file" id="fileInput" accept=".json,.xlsx">
    <p id="loadStatus" style="font-size: 0.8em; color: #6ee7b7; margin-top: 10px;"></p>
  </div>

  <div id="siteBlock" class="card filters" style="display:none">
    <div class="filtersRow">
      <div><label>Revista</label><select id="fSite"></select></div>
      <div><label>Producto</label><select id="fProduct"></select></div>
      <div><label>Sector</label><select id="fSector"></select></div>
      <div><label>Comercial</label><select id="fComercial"></select></div>
      <div><label>√Årea</label><select id="fArea"></select></div>
    </div>
  </div>

  <div id="filters" class="card filters" style="display:none">
    <div class="filtersRow">
      <div style="flex: 1; min-width: 300px;">
        <label style="color: var(--comp);">A√±o base</label><select id="fYear"></select>
        <div class="checkboxGroup" id="monthsBase"></div>
      </div>
      <div style="flex: 1; min-width: 300px;">
        <label style="color: var(--base);">A√±o comparaci√≥n</label><select id="fYear2"></select>
        <div class="checkboxGroup" id="monthsComp"></div>
      </div>
    </div>
  </div>

  <div id="totalBlock" class="card filters" style="display:none">
    <div class="totalBlock">
      <div class="totalValues">
        <div>A√±o base<span id="totalYear1" class="value">0 ‚Ç¨</span></div>
        <div>A√±o comparaci√≥n<span id="totalYear2" class="value">0 ‚Ç¨</span></div>
        <div>% Diferencia<span id="diffPercent" class="value">0%</span></div>
      </div>
    </div>
  </div>

  <div id="statsBlock" class="statsBlock" style="display:none">
      <div class="subBlock statsBase">
        <div class="statsValues">
          <div>Fact. Base<span id="totalStatsBase" class="value">0‚Ç¨</span></div>
          <div>L√≠neas<span id="linesStatsBase" class="value">0</span></div>
          <div>Presu. Medio<span id="avgStatsBase" class="value">0‚Ç¨</span></div>
        </div>
      </div>
      <div class="subBlock statsDiff">
        <div>Crecimiento Presupuesto Medio<span id="diffAvgStats" class="value" style="font-size: 1.5em;">0%</span></div>
      </div>
      <div class="subBlock statsComp">
        <div class="statsValues">
          <div>Fact. Comp.<span id="totalStatsComp" class="value">0‚Ç¨</span></div>
          <div>L√≠neas<span id="linesStatsComp" class="value">0</span></div>
          <div>Presu. Medio<span id="avgStatsComp" class="value">0‚Ç¨</span></div>
        </div>
      </div>
  </div>

  <div id="chartsGrid" class="grid" style="display:none">
    <div class="card"><h2>√Årea acumulada</h2><div id="chartArea" class="chart"></div></div>
    <div class="card"><h2>Barras agrupadas</h2><div id="chartBar" class="chart"></div></div>
    <div class="card"><h2>L√≠neas</h2><div id="chartLine" class="chart"></div></div>
    <div class="card"><h2>Barras apiladas</h2><div id="chartStack" class="chart"></div></div>
  </div>
</div>

<script>
const MONTHS=["01 Enero","02 Febrero","03 Marzo","04 Abril","05 Mayo","06 Junio","07 Julio","08 Agosto","09 Septiembre","10 Octubre","11 Noviembre","12 Diciembre"];
let rawData=[];

window.onload = async () => {
    const status = document.getElementById('loadStatus');
    try {
        status.textContent = "Buscando Print.json...";
        const response = await fetch('Print.json');
        if (!response.ok) throw new Error();
        
        const lastMod = response.headers.get('Last-Modified');
        let fechaTexto = lastMod ? new Date(lastMod).toLocaleDateString('es-ES', {day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'}) : "No disponible";

        const data = await response.json();
        init(data);
        
        status.innerHTML = "‚úì Datos de 'Print.json' cargados correctamente.<br>" + 
                          "<span style='color: #f59e0b; font-weight: bold;'>‚úì √öltima actualizaci√≥n en servidor: " + fechaTexto + "</span>";
    } catch (err) {
        status.textContent = "Aviso: Selecciona un archivo para empezar.";
    }
};

function normalizeText(s){ return s ? String(s).trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase() : ""; }
function normalizeMonth(m){ if(!m) return ""; const s = String(m).trim(); const nn = s.substring(0,2); return MONTHS.find(x=>x.startsWith(nn)) || ""; }
function num(v){ if(!v) return 0; let s = String(v).replace(/[‚Ç¨\.\s]/g,"").replace(",","."); return Number(s) || 0; }

function formatCurrency(n){ return Math.round(n).toLocaleString("es-ES") + "‚Ç¨"; }

fileInput.onchange=e=>{
  const f=e.target.files[0];
  const r=new FileReader();
  r.onload=ev=>{
    const ext=f.name.split(".").pop().toLowerCase();
    init(ext==="json" ? JSON.parse(ev.target.result) : XLSX.utils.sheet_to_json(XLSX.read(ev.target.result,{type:"binary"}).Sheets[0]));
  };
  f.name.endsWith("json")?r.readAsText(f):r.readAsBinaryString(f);
};

function init(data){
  rawData=data.map(d=>({
    ingreso: num(d["Imp.Neto a Comisionar"]),
    A√±o: normalizeText(d["A√±o inserci√≥n"]),
    Mes: normalizeMonth(d["Mes inserci√≥n"]),
    Site: normalizeText(d["Publicaci√≥n"]),
    Product: normalizeText(d["Producto"]),
    Sector: normalizeText(d["Sector del anunciante"]),
    Comercial: normalizeText(d["Comercial"]),
    Area: normalizeText(d["√ÅREA"])
  }));

  const populate = (id, arr) => {
    const s = document.getElementById(id);
    s.innerHTML = "<option>TODOS</option>" + arr.sort().map(v=>`<option>${v}</option>`).join("");
  };

  populate("fSite", [...new Set(rawData.map(d=>d.Site))]);
  populate("fProduct", [...new Set(rawData.map(d=>d.Product))]);
  populate("fSector", [...new Set(rawData.map(d=>d.Sector))]);
  populate("fComercial", [...new Set(rawData.map(d=>d.Comercial))]);
  populate("fArea", [...new Set(rawData.map(d=>d.Area))]);
  
  const years = [...new Set(rawData.map(d=>d.A√±o))].sort().reverse();
  fYear.innerHTML = years.map(y=>`<option>${y}</option>`).join("");
  fYear2.innerHTML = "<option>Sin comparar</option>" + years.map(y=>`<option>${y}</option>`).join("");

  document.getElementById("monthsBase").innerHTML=MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");
  document.getElementById("monthsComp").innerHTML=MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");

  [fSite,fProduct,fSector,fYear,fYear2,fComercial,fArea].forEach(e=>e.onchange=render);
  ["siteBlock","filters","totalBlock","statsBlock","chartsGrid"].forEach(id=>document.getElementById(id).style.display="block");
  render();
}

function render(){
  const getM = (id) => Array.from(document.getElementById(id).querySelectorAll("input:checked")).map(i=>i.value);
  const m1 = getM("monthsBase"), m2 = getM("monthsComp");
  
  const filter = (y,m) => rawData.filter(d=> (y==="TODOS"||d.A√±o===y) && (m.length===0||m.includes(d.Mes)) && (fSite.value==="TODOS"||d.Site===fSite.value) && (fProduct.value==="TODOS"||d.Product===fProduct.value) && (fSector.value==="TODOS"||d.Sector===fSector.value) && (fComercial.value==="TODOS"||d.Comercial===fComercial.value) && (fArea.value==="TODOS"||d.Area===fArea.value));

  const d1 = filter(fYear.value, m1), d2 = fYear2.value!=="Sin comparar" ? filter(fYear2.value, m2) : [];
  
  const calc = (data) => {
    const total = data.reduce((a,b)=>a+b.ingreso,0);
    const lines = data.filter(d=>d.ingreso>0).length;
    return { total, lines, avg: lines ? Math.round(total/lines) : 0 };
  };

  const s1 = calc(d1), s2 = calc(d2);
  
  totalYear1.textContent = formatCurrency(s1.total);
  totalStatsBase.textContent = formatCurrency(s1.total);
  linesStatsBase.textContent = s1.lines;
  avgStatsBase.textContent = formatCurrency(s1.avg);

  if(fYear2.value!=="Sin comparar"){
    totalYear2.textContent = formatCurrency(s2.total);
    totalStatsComp.textContent = formatCurrency(s2.total);
    linesStatsComp.textContent = s2.lines;
    avgStatsComp.textContent = formatCurrency(s2.avg);
    
    const dPct = s2.total ? Math.round((s1.total/s2.total -1)*100) : 0;
    diffPercent.textContent = dPct+"%";
    diffPercent.style.color = dPct<0?"var(--neg)":"#6ee7b7";
    
    const aPct = s2.avg ? Math.round((s1.avg/s2.avg -1)*100) : 0;
    diffAvgStats.textContent = aPct+"%";
    diffAvgStats.style.color = aPct<0?"var(--neg)":"#000";
  }

  const series = (data) => MONTHS.map(m => data.filter(d=>d.Mes===m).reduce((a,b)=>a+b.ingreso,0));
  const v1 = series(d1), v2 = fYear2.value!=="Sin comparar" ? series(d2) : null;

  const layout = { paper_bgcolor:"rgba(0,0,0,0)", plot_bgcolor:"rgba(0,0,0,0)", font:{color:"#eee", size:10}, margin:{t:20,b:40,l:50,r:10}, legend:{orientation:"h", y:-0.2} };
  
  const tr = (v, n, c, type="scatter") => ({ x:MONTHS.map(m=>m.slice(3)), y:v, name:n, type:type, marker:{color:c}, line:{color:c} });

  Plotly.newPlot("chartLine", [tr(v1, fYear.value, "#38bdf8")].concat(v2?[tr(v2, fYear2.value, "#f59e0b")]:[]), layout);
  Plotly.newPlot("chartBar", [tr(v1, fYear.value, "#38bdf8", "bar")].concat(v2?[tr(v2, fYear2.value, "#f59e0b", "bar")]:[]), {...layout, barmode:"group"});
  Plotly.newPlot("chartArea", [tr(v1, fYear.value, "#38bdf8")].concat(v2?[tr(v2, fYear2.value, "#f59e0b")]:[]).map(t=>({...t, fill:'tozeroy'})), layout);
  Plotly.newPlot("chartStack", [tr(v1, fYear.value, "#38bdf8", "bar")].concat(v2?[tr(v2, fYear2.value, "#f59e0b", "bar")]:[]), {...layout, barmode:"stack"});
}
</script>
</body>
</html>